<!DOCTYPE html>
<html lang="ja" xmlns:th="http://www.thymeleaf.org">
<head>
    <meta charset="UTF-8" />
    <title th:text="${pageTitle}"></title> <link href="https://fonts.googleapis.com/css2?family=Roboto&display=swap" rel="stylesheet">
    <style>
        /* ã“ã“ã«ã”æç¤ºã„ãŸã ã„ãŸCSSã‚¹ã‚¿ã‚¤ãƒ«ã‚’ãã®ã¾ã¾è²¼ã‚Šä»˜ã‘ã¾ã™ */
        html, body {
            margin: 0;
            padding: 0;
            font-family: 'Roboto', sans-serif;
            background-color: #fffef9;
            height: 100vh;
        }

        .sidebar {
            position: fixed;
            top: 0;
            left: 0;
            width: 160px;
            height: 100vh;
            background-color: #fff3e0;
            padding-top: 2rem;
            box-shadow: 2px 0 5px rgba(0,0,0,0.1);
            display: flex;
            flex-direction: column;
            align-items: center;
            z-index: 999;
        }

        .sidebar button {
            width: 120px;
            margin: 0.5rem 0;
            padding: 0.5rem;
            font-size: 0.95rem;
            background-color: #fb8500;
            color: white;
            border: none;
            border-radius: 6px;
            cursor: pointer;
        }

        .sidebar button:hover {
            background-color: #d95d0c;
        }

        .main-content {
            margin-left: 180px;
            padding: 2rem;
            height: 100vh;
            box-sizing: border-box;
            overflow-y: auto;
        }

        .weather-icon {
            position: fixed;
            top: 20px;
            right: 30px;
            font-size: 1.8rem;
            cursor: pointer;
            z-index: 1001;
        }

        .weather-popup {
            position: fixed;
            top: 60px;
            right: 30px;
            background-color: #ffffff;
            border: 1px solid #ccc;
            box-shadow: 0 2px 6px rgba(0, 0, 0, 0.2);
            padding: 15px;
            border-radius: 8px;
            display: none; /* ãƒ‡ãƒ•ã‚©ãƒ«ãƒˆã§éè¡¨ç¤º */
            z-index: 1000;
            width: 220px;
        }

        .weather-popup .controls {
            display: flex;
            justify-content: space-between;
            margin-top: 10px;
        }

        .weather-popup button {
            background-color: #fb8500;
            color: white;
            border: none;
            padding: 4px 8px;
            border-radius: 4px;
            cursor: pointer;
            font-size: 0.8rem;
        }

        .weather-popup button:hover {
            background-color: #d95d0c;
        }

        .box {
            background-color: #ffffff;
            border-left: 6px solid #ffb703;
            box-shadow: 0 2px 6px rgba(0, 0, 0, 0.1);
            padding: 20px 30px;
            border-radius: 8px;
            max-width: 1000px;
            margin: 0 auto;
            display: flex;
            flex-direction: column;
            gap: 20px;
        }

        h2 {
            font-size: 1.8rem;
            margin-bottom: 10px;
            color: #fb8500;
        }

        label {
            font-weight: bold;
            margin-right: 10px;
        }

        input[type="date"],
        input[type="number"],
        input[type="text"] {
            padding: 6px;
            font-size: 0.9rem;
            width: 220px;
            border: 1px solid #ccc;
            border-radius: 4px;
        }

        .input-row {
            display: flex;
            gap: 40px;
            align-items: center;
        }

        table {
            width: 100%;
            border-collapse: collapse;
        }

        table th,
        table td {
            border: 1px solid #ccc;
        }

        table th {
            background-color: #ffb703;
            color: white;
            padding: 6px;
            font-size: 0.9rem;
        }

        table td {
            text-align: center;
            padding: 6px;
        }

        .button-group {
            display: flex;
            justify-content: flex-start;
            gap: 15px;
            flex-wrap: wrap;
        }

        .button {
            background-color: #fb8500;
            color: white;
            padding: 8px 16px;
            font-size: 0.9rem;
            border: none;
            border-radius: 5px;
            cursor: pointer;
            transition: background-color 0.3s;
        }

        .button:hover {
            background-color: #d95d0c;
        }

        /* ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸è¡¨ç¤ºç”¨ã®ã‚¹ã‚¿ã‚¤ãƒ« */
        .alert {
            padding: 10px;
            margin-bottom: 15px;
            border-radius: 5px;
            text-align: center;
        }
        .alert-danger {
            background-color: #f8d7da;
            color: #721c24;
            border: 1px solid #f5c6cb;
        }
        .alert-success {
            background-color: #d4edda;
            color: #155724;
            border: 1px solid #c3e6cb;
        }
    </style>
</head>
<body>
    <div class="sidebar">
        <button onclick="location.href='/forecast'">ğŸ“¦ ç™ºæ³¨äºˆæ¸¬</button>
        <button onclick="location.href='/weather'">â›… å¤©æ°—å¯è¦–åŒ–</button>
        <button onclick="location.href='/sales/input'">âœï¸ å®Ÿç¸¾å…¥åŠ›</button> <button onclick="location.href='/account'">ğŸ‘¤ ã‚¢ã‚«ã‚¦ãƒ³ãƒˆç®¡ç†</button>
        <button onclick="location.href='/sales/list'">ä¸€è¦§è¡¨ç¤º</button> <button onclick="location.href='/logout'">ãƒ­ã‚°ã‚¢ã‚¦ãƒˆ</button> </div>

    <div class="weather-icon" onclick="toggleWeatherPopup()">â›…</div>
    <div class="weather-popup" id="weatherPopup">
        <div th:if="${todayWeather != null}" id="weatherContent">
            <strong>ä»Šæ—¥ã®å¤©æ°—æƒ…å ±</strong><br>
            <span style="font-size: 0.85rem; color: #555;" th:text="${todayWeather.date}"></span><br>
            <span th:text="${todayWeather.weatherCode.weatherName}"></span><br>
            <span th:text="${todayWeather.temperatureMin}"></span>â„ƒ ~ <span th:text="${todayWeather.temperatureMax}"></span>â„ƒ<br>
            <span>ğŸŒ¬ï¸é¢¨é€Ÿï¼š<span th:text="${todayWeather.windspeedMax}"></span> m/s (æœ€å¤§)</span><br>
            <span>ğŸ’§æ¹¿åº¦ï¼š<span th:text="${todayWeather.humidityMin}"></span>% ~ <span th:text="${todayWeather.humidityMax}"></span>%</span>
        </div>
        <div th:if="${todayWeather == null}" id="weatherContent">
            å¤©æ°—æƒ…å ±ãŒã‚ã‚Šã¾ã›ã‚“ã€‚
        </div>
        </div>

    <div class="main-content">
        <div class="box">
            <h2 th:text="${pageTitle}">è²©å£²å®Ÿç¸¾å…¥åŠ›</h2>

            <div th:if="${errorMessage}" class="alert alert-danger" role="alert">
                <span th:text="${errorMessage}"></span>
            </div>

            <div th:if="${successMessage}" class="alert alert-success" role="alert">
                <span th:text="${successMessage}"></span>
            </div>

            <form th:action="@{/sales/input}" th:object="${salesInputForm}" method="post">
                <div class="input-row">
                    <div>
                        <label for="date">è²©å£²æ—¥ä»˜ï¼š</label>
                        <input type="date" id="date" th:field="*{date}" class="form-control"
                               th:readonly="${!isAdmin}"
                               th:attr="onchange=${isAdmin ? 'this.form.submit()' : ''}"
                               required>
                        <br>
                        <small th:if="${isAdmin}" style="font-size: 0.8rem; color: #555;">æ—¥ä»˜ã‚’å¤‰æ›´ã™ã‚‹ã¨ã€ãã®æ—¥ã®å®Ÿç¸¾ã‚’ä¿®æ­£ã§ãã¾ã™ã€‚</small>
                    </div>
                    <!-- <div>
                        <label>è¨˜éŒ²è€…ï¼ˆç¤¾å“¡IDï¼‰ï¼š</label>
                        <span id="recorder-display" th:text="${#authentication.name}"></span> <input type="hidden" th:field="*{recorderId}" /> </div> -->
                </div>

                <table>
                    <thead>
                        <tr>
                            <th>å•†å“å</th>
                            <th>è²©å£²æœ¬æ•°</th>
                            <th>å£²ä¸Šé‡‘é¡ï¼ˆå††ï¼‰</th>
                        </tr>
                    </thead>
                    <tbody>
                        <tr th:each="entry, stat : *{performances}">
                            <td th:text="${entry.productName}"></td>
                            <td>
                                <input type="number"
                                       th:id="${'quantity_' + stat.index}"
                                       th:field="*{performances[__${stat.index}__].quantity}"
                                       class="form-control"
                                       min="0"
                                       step="1"
                                       th:attr="oninput='updatePrice(this, ' + ${products.?[name == entry.productName][0].price} + ')'"
                                       required>
                                <input type="hidden" th:field="*{performances[__${stat.index}__].productName}" />
                            </td>
                            <td class="price" th:id="${'price_' + stat.index}">0</td>
                        </tr>
                    </tbody>
                </table>
                <div class="button-group">
                    <button type="submit" class="button">ç™»éŒ²/æ›´æ–°</button> </div>

                <!-- <input type="hidden" th:name="${_csrf.parameterName}" th:value="${_csrf.token}" /> -->
            </form>
        </div>
    </div>

    <script>
        // JSã®åˆæœŸåŒ–å‡¦ç†ã¯Thymeleafã§æ—¥ä»˜ã‚’è¨­å®šã™ã‚‹ãŸã‚å‰Šé™¤
        // document.getElementById('date').valueAsDate = new Date();

        function updatePrice(input, pricePerUnit) {
            const quantity = parseInt(input.value) || 0;
            const priceCell = input.closest('tr').querySelector('.price');
            priceCell.textContent = quantity * pricePerUnit;
        }

        // ãƒšãƒ¼ã‚¸ãƒ­ãƒ¼ãƒ‰æ™‚ã«æ—¢å­˜ã®æ•°é‡ã«åŸºã¥ã„ã¦å£²ä¸Šé‡‘é¡ã‚’è¨ˆç®—ã—è¡¨ç¤º
        document.addEventListener('DOMContentLoaded', function() {
            // ç¾åœ¨ã®ãƒ•ã‚©ãƒ¼ãƒ ã® quantities ã‚’å–å¾—ã—ã€ä¾¡æ ¼ã‚’æ›´æ–°
            document.querySelectorAll('input[type="number"][id^="quantity_"]').forEach(input => {
                const index = input.id.split('_')[1];
                const pricePerUnit = parseFloat(input.getAttribute('oninput').match(/\d+/)[0]); // oninputå±æ€§ã‹ã‚‰ä¾¡æ ¼ã‚’å–å¾—
                updatePrice(input, pricePerUnit);
            });
            // å¤©æ°—ãƒãƒƒãƒ—ã‚¢ãƒƒãƒ—ã®åˆæœŸè¡¨ç¤ºè¨­å®š
            updateWeatherContent(); // ç¾åœ¨ã®å¤©æ°—æƒ…å ±ã‚’è¡¨ç¤º
        });

        // submitSales() ã¨ modifyData() ã¯ã‚µãƒ¼ãƒãƒ¼ã‚µã‚¤ãƒ‰ã§ã®å‡¦ç†ã«ç½®ãæ›ã‚ã‚‹ãŸã‚å‰Šé™¤
        // function submitSales() { alert("è²©å£²å®Ÿç¸¾ã‚’ç™»éŒ²ã—ã¾ã—ãŸã€‚"); }
        // function modifyData() { ... }

        // å¤©æ°—ãƒãƒƒãƒ—ã‚¢ãƒƒãƒ—ã®ãƒˆã‚°ãƒ«æ©Ÿèƒ½
        function toggleWeatherPopup() {
            const popup = document.getElementById('weatherPopup');
            popup.style.display = popup.style.display === 'block' ? 'none' : 'block';
        }

        // weatherContentã®è¡¨ç¤ºæ›´æ–°ï¼ˆãƒãƒƒã‚¯ã‚¨ãƒ³ãƒ‰ãƒ‡ãƒ¼ã‚¿ã«åŸºã¥ãï¼‰
        // Controllerã‹ã‚‰æ¸¡ã•ã‚ŒãŸtodayWeatherã‚’ä½¿ç”¨ã™ã‚‹ãŸã‚ã€JavaScriptã®weatherDataé…åˆ—ã¯ä¸è¦
        function updateWeatherContent() {
            // ThymeleafãŒæ—¢ã«ã‚µãƒ¼ãƒã‚µã‚¤ãƒ‰ã§todayWeatherã‚’è¡¨ç¤ºã—ã¦ã„ã‚‹ãŸã‚ã€JSã§å‹•çš„ã«æ›´æ–°ã™ã‚‹å¿…è¦ã¯å°‘ãªã„
            // ã—ã‹ã—ã€ãƒãƒƒãƒ—ã‚¢ãƒƒãƒ—è¡¨ç¤ºæ™‚ã«å¸¸ã«æœ€æ–°ã®çŠ¶æ…‹ã‚’ä¿è¨¼ã—ãŸã„å ´åˆã€ã¾ãŸã¯è¤‡é›‘ãªè¡¨ç¤ºãƒ­ã‚¸ãƒƒã‚¯ãŒã‚ã‚‹å ´åˆã«åˆ©ç”¨
            // ä»Šå›ã¯Thymeleafã§è¡¨ç¤ºæ¸ˆã¿ã®ãŸã‚ã€ã“ã®é–¢æ•°ã¯ãƒãƒƒãƒ—ã‚¢ãƒƒãƒ—è¡¨ç¤º/éè¡¨ç¤ºã®åˆ¶å¾¡ã®ã¿ã‚’ç›®çš„ã¨ã™ã‚‹
            console.log("Weather content updated (Thymeleaf already handled display).");
        }

        // changeWeatherã¯ã€ãƒãƒƒã‚¯ã‚¨ãƒ³ãƒ‰ã®å¤©æ°—ãƒ‡ãƒ¼ã‚¿ãŒç¾åœ¨æ—¥ã®ã¿ã®ãŸã‚ã€ä¸è¦
        // function changeWeather(direction) { ... }

    </script>
</body>
</html>