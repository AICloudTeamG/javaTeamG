<!DOCTYPE html>
<html lang="ja" xmlns:th="http://www.thymeleaf.org">
<head>
    <meta charset="UTF-8" />
    <title th:text="${pageTitle}"></title> <link href="https://fonts.googleapis.com/css2?family=Roboto&display=swap" rel="stylesheet">
    <style>
        /* ここにご提示いただいたCSSスタイルをそのまま貼り付けます */
        html, body {
            margin: 0;
            padding: 0;
            font-family: 'Roboto', sans-serif;
            background-color: #fffef9;
            height: 100vh;
        }

        .sidebar {
            position: fixed;
            top: 0;
            left: 0;
            width: 160px;
            height: 100vh;
            background-color: #fff3e0;
            padding-top: 2rem;
            box-shadow: 2px 0 5px rgba(0,0,0,0.1);
            display: flex;
            flex-direction: column;
            align-items: center;
            z-index: 999;
        }

        .sidebar button {
            width: 120px;
            margin: 0.5rem 0;
            padding: 0.5rem;
            font-size: 0.95rem;
            background-color: #fb8500;
            color: white;
            border: none;
            border-radius: 6px;
            cursor: pointer;
        }

        .sidebar button:hover {
            background-color: #d95d0c;
        }

        .main-content {
            margin-left: 180px;
            padding: 2rem;
            height: 100vh;
            box-sizing: border-box;
            overflow-y: auto;
        }

        .weather-icon {
            position: fixed;
            top: 20px;
            right: 30px;
            font-size: 1.8rem;
            cursor: pointer;
            z-index: 1001;
        }

        .weather-popup {
            position: fixed;
            top: 60px;
            right: 30px;
            background-color: #ffffff;
            border: 1px solid #ccc;
            box-shadow: 0 2px 6px rgba(0, 0, 0, 0.2);
            padding: 15px;
            border-radius: 8px;
            display: none; /* デフォルトで非表示 */
            z-index: 1000;
            width: 220px;
        }

        .weather-popup .controls {
            display: flex;
            justify-content: space-between;
            margin-top: 10px;
        }

        .weather-popup button {
            background-color: #fb8500;
            color: white;
            border: none;
            padding: 4px 8px;
            border-radius: 4px;
            cursor: pointer;
            font-size: 0.8rem;
        }

        .weather-popup button:hover {
            background-color: #d95d0c;
        }

        .box {
            background-color: #ffffff;
            border-left: 6px solid #ffb703;
            box-shadow: 0 2px 6px rgba(0, 0, 0, 0.1);
            padding: 20px 30px;
            border-radius: 8px;
            max-width: 1000px;
            margin: 0 auto;
            display: flex;
            flex-direction: column;
            gap: 20px;
        }

        h2 {
            font-size: 1.8rem;
            margin-bottom: 10px;
            color: #fb8500;
        }

        label {
            font-weight: bold;
            margin-right: 10px;
        }

        input[type="date"],
        input[type="number"],
        input[type="text"] {
            padding: 6px;
            font-size: 0.9rem;
            width: 220px;
            border: 1px solid #ccc;
            border-radius: 4px;
        }

        .input-row {
            display: flex;
            gap: 40px;
            align-items: center;
        }

        table {
            width: 100%;
            border-collapse: collapse;
        }

        table th,
        table td {
            border: 1px solid #ccc;
        }

        table th {
            background-color: #ffb703;
            color: white;
            padding: 6px;
            font-size: 0.9rem;
        }

        table td {
            text-align: center;
            padding: 6px;
        }

        .button-group {
            display: flex;
            justify-content: flex-start;
            gap: 15px;
            flex-wrap: wrap;
        }

        .button {
            background-color: #fb8500;
            color: white;
            padding: 8px 16px;
            font-size: 0.9rem;
            border: none;
            border-radius: 5px;
            cursor: pointer;
            transition: background-color 0.3s;
        }

        .button:hover {
            background-color: #d95d0c;
        }

        /* メッセージ表示用のスタイル */
        .alert {
            padding: 10px;
            margin-bottom: 15px;
            border-radius: 5px;
            text-align: center;
        }
        .alert-danger {
            background-color: #f8d7da;
            color: #721c24;
            border: 1px solid #f5c6cb;
        }
        .alert-success {
            background-color: #d4edda;
            color: #155724;
            border: 1px solid #c3e6cb;
        }
    </style>
</head>
<body>
    <div class="sidebar">
        <button onclick="location.href='/forecast'">📦 発注予測</button>
        <button onclick="location.href='/weather'">⛅ 天気可視化</button>
        <button onclick="location.href='/sales/input'">✍️ 実績入力</button> <button onclick="location.href='/account'">👤 アカウント管理</button>
        <button onclick="location.href='/sales/list'">一覧表示</button> <button onclick="location.href='/logout'">ログアウト</button> </div>

    <div class="weather-icon" onclick="toggleWeatherPopup()">⛅</div>
    <div class="weather-popup" id="weatherPopup">
        <div th:if="${todayWeather != null}" id="weatherContent">
            <strong>今日の天気情報</strong><br>
            <span style="font-size: 0.85rem; color: #555;" th:text="${todayWeather.date}"></span><br>
            <span th:text="${todayWeather.weatherCode.weatherName}"></span><br>
            <span th:text="${todayWeather.temperatureMin}"></span>℃ ~ <span th:text="${todayWeather.temperatureMax}"></span>℃<br>
            <span>🌬️風速：<span th:text="${todayWeather.windspeedMax}"></span> m/s (最大)</span><br>
            <span>💧湿度：<span th:text="${todayWeather.humidityMin}"></span>% ~ <span th:text="${todayWeather.humidityMax}"></span>%</span>
        </div>
        <div th:if="${todayWeather == null}" id="weatherContent">
            天気情報がありません。
        </div>
        </div>

    <div class="main-content">
        <div class="box">
            <h2 th:text="${pageTitle}">販売実績入力</h2>

            <div th:if="${errorMessage}" class="alert alert-danger" role="alert">
                <span th:text="${errorMessage}"></span>
            </div>

            <div th:if="${successMessage}" class="alert alert-success" role="alert">
                <span th:text="${successMessage}"></span>
            </div>

            <form th:action="@{/sales/input}" th:object="${salesInputForm}" method="post">
                <div class="input-row">
                    <div>
                        <label for="date">販売日付：</label>
                        <input type="date" id="date" th:field="*{date}" class="form-control"
                               th:readonly="${!isAdmin}"
                               th:attr="onchange=${isAdmin ? 'this.form.submit()' : ''}"
                               required>
                        <br>
                        <small th:if="${isAdmin}" style="font-size: 0.8rem; color: #555;">日付を変更すると、その日の実績を修正できます。</small>
                    </div>
                    <!-- <div>
                        <label>記録者（社員ID）：</label>
                        <span id="recorder-display" th:text="${#authentication.name}"></span> <input type="hidden" th:field="*{recorderId}" /> </div> -->
                </div>

                <table>
                    <thead>
                        <tr>
                            <th>商品名</th>
                            <th>販売本数</th>
                            <th>売上金額（円）</th>
                        </tr>
                    </thead>
                    <tbody>
                        <tr th:each="entry, stat : *{performances}">
                            <td th:text="${entry.productName}"></td>
                            <td>
                                <input type="number"
                                       th:id="${'quantity_' + stat.index}"
                                       th:field="*{performances[__${stat.index}__].quantity}"
                                       class="form-control"
                                       min="0"
                                       step="1"
                                       th:attr="oninput='updatePrice(this, ' + ${products.?[name == entry.productName][0].price} + ')'"
                                       required>
                                <input type="hidden" th:field="*{performances[__${stat.index}__].productName}" />
                            </td>
                            <td class="price" th:id="${'price_' + stat.index}">0</td>
                        </tr>
                    </tbody>
                </table>
                <div class="button-group">
                    <button type="submit" class="button">登録/更新</button> </div>

                <!-- <input type="hidden" th:name="${_csrf.parameterName}" th:value="${_csrf.token}" /> -->
            </form>
        </div>
    </div>

    <script>
        // JSの初期化処理はThymeleafで日付を設定するため削除
        // document.getElementById('date').valueAsDate = new Date();

        function updatePrice(input, pricePerUnit) {
            const quantity = parseInt(input.value) || 0;
            const priceCell = input.closest('tr').querySelector('.price');
            priceCell.textContent = quantity * pricePerUnit;
        }

        // ページロード時に既存の数量に基づいて売上金額を計算し表示
        document.addEventListener('DOMContentLoaded', function() {
            // 現在のフォームの quantities を取得し、価格を更新
            document.querySelectorAll('input[type="number"][id^="quantity_"]').forEach(input => {
                const index = input.id.split('_')[1];
                const pricePerUnit = parseFloat(input.getAttribute('oninput').match(/\d+/)[0]); // oninput属性から価格を取得
                updatePrice(input, pricePerUnit);
            });
            // 天気ポップアップの初期表示設定
            updateWeatherContent(); // 現在の天気情報を表示
        });

        // submitSales() と modifyData() はサーバーサイドでの処理に置き換わるため削除
        // function submitSales() { alert("販売実績を登録しました。"); }
        // function modifyData() { ... }

        // 天気ポップアップのトグル機能
        function toggleWeatherPopup() {
            const popup = document.getElementById('weatherPopup');
            popup.style.display = popup.style.display === 'block' ? 'none' : 'block';
        }

        // weatherContentの表示更新（バックエンドデータに基づく）
        // Controllerから渡されたtodayWeatherを使用するため、JavaScriptのweatherData配列は不要
        function updateWeatherContent() {
            // Thymeleafが既にサーバサイドでtodayWeatherを表示しているため、JSで動的に更新する必要は少ない
            // しかし、ポップアップ表示時に常に最新の状態を保証したい場合、または複雑な表示ロジックがある場合に利用
            // 今回はThymeleafで表示済みのため、この関数はポップアップ表示/非表示の制御のみを目的とする
            console.log("Weather content updated (Thymeleaf already handled display).");
        }

        // changeWeatherは、バックエンドの天気データが現在日のみのため、不要
        // function changeWeather(direction) { ... }

    </script>
</body>
</html>